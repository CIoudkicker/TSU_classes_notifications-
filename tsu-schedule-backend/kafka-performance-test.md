### Тестирование производительности

**Цель теста:** Оценить производительность приложений Node.js под нагрузкой Kafka.

**Этапы проверки:**
1. Предварительное условие: перед запуском кода была установлена ​​библиотека kafkajs (ее можно установить, запустив `npm install kafkajs`), и была запущена команда `docker-compose up --build`,Откройте инструмент тестирования производительности.В этом тесте используется Apache JMeter для имитации создания и потребления большого количества одновременных сообщений.
2. В JMeter создайте новый план тестирования, щелкните правой кнопкой мыши TestPlan->Add->Threads(Users)->Thread Group.
3. Щелкните правой кнопкой мыши только что созданную группу потоков, выберите Add->Sampler и выберите KafkaProducerSampler.
4. Нажмите KafkaProducerSampler, чтобы установить Kafka Topic на my-topic и Kafka Message Key на my-key.
![](https://huatu.98youxi.com/markdown/work/uploads/upload_d6bdea181f61b44d992460302137c6f1.png)

5. Необходимо добавить параметры конфигурации Kafka, нажмите KafkaTestPlan->Add->Config Element​， конфигурации, нажмите kafkaProducerConfig, вы можете установить конфигурацию свойств, связанных с Kafka.
  ![](https://huatu.98youxi.com/markdown/work/uploads/upload_ea68a16985e340861e77ebf16f529319.png)

6. Установите параметры стресс-теста, например, установите 1 поток и запустите в общей сложности 1000 раз.
![](https://huatu.98youxi.com/markdown/work/uploads/upload_5f9fc9a22f6726f20da6a0239dc11f00.png)

7. Таким же образом добавьте потребителя KafkaConsumerSampler и настройте различные параметры потребителя.
![](https://huatu.98youxi.com/markdown/work/uploads/upload_fe9059803b5171df2f283413970a587b.png)
![](https://huatu.98youxi.com/markdown/work/uploads/upload_365aa5a4fd533195d3e984d09954ec4d.png)

8. Щелкните правой кнопкой мыши Add -> Listener -> Aggregate Report в плане тестирования.
9. Щелкните зеленый значок «Начать тестирование», чтобы протестировать ключевые показатели производительности, такие как среднее время отклика, пропускная способность и коэффициент исключений.
10. Увеличивайте или уменьшайте количество одновременных сообщений и наблюдайте за изменениями производительности приложения Node.js.

**Результаты теста:**
Смоделируйте создание и потребление 1000 одновременных сообщений с помощью инструмента Apache JMeter.

  ![](https://huatu.98youxi.com/markdown/work/uploads/upload_49dd111e4ee8b5c53f4e23cf7bd664c4.png)

- Среднее время отклика производителя: 1 мс
- Пропускная способность производителя: 883,4 сообщения/сек.
- Скорость получения производителем: 6,04 КБ/с
- Среднее время отклика потребителя: 4 мс
- Потребительская пропускная способность: 213,5 сообщений/сек.
- Скорость приема потребителя: 12,72 КБ/с
- Частота ошибок равна 0 как для потребителя, так и для производителя

Увеличьте количество одновременных сообщений до 5000 и снова выполните тест производительности.

  ![](https://huatu.98youxi.com/markdown/work/uploads/upload_ce9ca1383fa6cc64417faa3e2ed7f340.png)

- Среднее время отклика производителя: 1 мс
- Пропускная способность производителя: 672,2 сообщения/сек.
- Скорость получения производителем: 4,60 КБ/с
- Среднее время отклика потребителя: 1 мс
- Потребительская пропускная способность: 518,1 сообщений/сек.
- Скорость приема потребителя: 30,87 КБ/с
- Частота ошибок равна 0 как для потребителя, так и для производителя

Сократите количество одновременных сообщений до 100 и повторно запустите тест производительности.

  ![](https://huatu.98youxi.com/markdown/work/uploads/upload_3fe9bfadb6fdb113bfe83d75a9aaa018.png)

- Среднее время отклика производителя: 1 мс
- Пропускная способность производителя: 492,6 сообщений/сек.
- Скорость получения производителем: 3,37 КБ/с
- Среднее время отклика потребителя: 31 мс
- Потребительская пропускная способность: 31,2 сообщения/сек.
- Скорость приема потребителя: 1,86 КБ/с
- Частота ошибок равна 0 как для потребителя, так и для производителя

**Вывод теста:**
По результатам испытаний можно сделать следующие выводы:
Приложения Node.js могут поддерживать стабильную производительность под нагрузкой Kafka, а также могут масштабироваться и адаптироваться к требованиям к обработке сообщений с высокой степенью параллелизма. По мере увеличения количества одновременных сообщений время отклика и задержка немного увеличиваются, но пропускная способность остается высокой. Результаты тестирования показывают, что приложения Node.js хорошо работают при обработке большого количества одновременных сообщений. Тест производительности пройден.

**Примечание:**
Шаги по установке Apache JMeter на centos7 следующие:
1. Установите Java: используйте команду, чтобы проверить, установлена ​​ли Java, команда `java -version`. Если Java не установлена, установите ее при необходимости.
2. Загрузите и установите Apache JMeter. Вы можете загрузить и установить Apache JMeter с официального сайта Apache JMeter [https://jmeter.apache.org/download_jmeter.cgi?Preferred=https%3A%2F%2Fdlcdn.apache.org. %2F](https://jmeter.apache.org/download_jmeter.cgi?Preferred=https%3A%2F%2Fdlcdn.apache.org%2F) скачать.
3. Распакуйте двоичный пакет JMeter: используйте следующую команду, чтобы распаковать загруженный двоичный пакет, команда `tar -xvf apache-jmeter-<version>.tgz`, где `<version>` — номер версии JMeter. вы скачали.
4. Загрузите сторонний подключаемый модуль JMeter. Загрузите сторонний подключаемый модуль JMeter с [https://github.com/rollno748/di-kafkameter](https://github.com/rollno748/di- kafkameter) и поместите его в каталог `lib/ext` пути установки JMeter.
5. Запустите JMeter: войдите в распакованный каталог JMeter и выполните следующую команду, чтобы запустить JMeter:

```
cd apache-jmeter-<version>/bin
./jmeter
```

**Конфигурация тестовой среды:**
- Операционная система: CentOS 7
- Версия Node.js: 14.15.4.
- Версия Кафки: 3.3.1
- Версия Apache JMeter: 5.6